(()=>{"use strict";var e=function(e,n,o){var r=n.handleDeleteCard,c=n.handleLikeCard,a=n.handleOpenCard,u=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0),i=u.querySelector(".card__image"),s=u.querySelector(".card__title"),l=u.querySelector(".card__delete-button"),d=u.querySelector(".card__like-button"),f=u.querySelector(".card__like-counter"),p=!!e.likes&&e.likes.some((function(e){return e._id===o}));return i.src=e.link,i.alt=e.name,s.textContent=e.name,f.textContent=e.likes?e.likes.length:0,e.owner._id!==o&&l.classList.add("card__delete-button_disabled"),p&&t(d),l.addEventListener("click",(function(){return r(e._id,u)})),d.addEventListener("click",(function(){return c(d,f,e._id)})),i.addEventListener("click",(function(){return a(e.link,e.alt,e.name)})),u},t=function(e){e.classList.toggle("card__like-button_is-active")},n=function(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",r)},o=function(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",r)},r=function(e){if("Escape"===e.key){var t=document.querySelector(".popup_is-opened");t&&o(t)}},c=/^[a-zа-яё\-\s]+$/i,a=/^(https?:\/\/)?([\w.-]+)\.([a-z]{2,})(\/.*)?$/i,u=function(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);n.forEach((function(n){return d(e,n,t.inputErrorClass,t.errorClass)})),i(n,o,t.inactiveButtonClass)};function i(e,t,n){!function(e){return e.some((function(e){return!s(e)}))}(e)?t.classList.remove(n):t.classList.add(n)}var s=function(e){var t=e.validity.valid;return f(e)||(t=!1),t},l=function(e,t,n,o){var r=e.querySelector(".popup__error_type_".concat(t.name));t.classList.add(n),r.textContent=t.validationMessage,t.validity.valid&&!f(t)&&p(t)&&(r.textContent=t.dataset.errorMessage),r.classList.add(o)},d=function(e,t,n,o){var r=e.querySelector(".popup__error_type_".concat(t.name));t.classList.remove(n),r.classList.remove(o),r.textContent=""},f=function(e){return p(e)?c.test(e.value):!m(e)||a.test(e.value)},p=function(e){var t=!1;return"name"!==e.name&&"place-name"!==e.name&&"description"!==e.name||(t=!0),t},m=function(e){var t=!1;return"link"===e.name&&(t=!0),t},h={baseUrl:"https://nomoreparties.co/v1/wff-cohort-39/",headers:{authorization:"3e77b996-5a4b-4cbf-94e8-9001ccd7f1ef","Content-Type":"application/json"}},_=document.querySelector(".places__list"),v=document.querySelector(".profile__edit-button"),y=document.querySelector(".profile__add-button"),S=document.querySelector(".profile__image-overlay"),k=document.querySelectorAll(".popup"),C=document.querySelector(".popup_type_edit"),b=document.querySelector(".popup_type_new-card"),E=document.querySelector(".popup_type_image"),q=document.querySelector(".popup__image"),L=document.querySelector(".popup__caption"),g=document.querySelector(".popup_type_delete-card"),x=document.querySelector(".popup_type_update-avatar"),j=document.forms["edit-profile"],P=j.elements.name,A=j.elements.description,T=document.forms["new-place"],U=T.elements["place-name"],w=T.elements.link,B=document.forms["delete-card"],D=document.forms["update-avatar"],O=document.querySelector(".profile__title"),N=document.querySelector(".profile__description"),z=document.querySelector(".profile__image"),H={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},J="Сохранение...";function G(e,t,o){q.src=e,q.alt=t,L.textContent=o,n(E)}!function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((function(t){t.addEventListener("submit",(function(e){e.preventDefault()}));var n=Array.from(t.querySelectorAll(e.inputSelector)),o=t.querySelector(e.submitButtonSelector);u(t,e),n.forEach((function(r){p(r)&&r.setAttribute("data-error-message","Разрешены только латинские, кириллические буквы, знаки дефиса и пробелы"),r.addEventListener("input",(function(){(function(e,t,n,o){s(t)?d(e,t,n,o):l(e,t,n,o)})(t,r,e.inputErrorClass,e.errorClass),i(n,o,e.inactiveButtonClass)}))}))}))}(H),Promise.all([fetch("".concat(h.baseUrl,"/users/me"),{method:"GET",headers:h.headers}).then((function(e){return e.ok?e.json():Promise.reject(e.status)})).then((function(e){return e})).catch((function(e){console.log("Ошибка: ".concat(e))})),fetch("".concat(h.baseUrl,"/cards"),{method:"GET",headers:h.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).then((function(e){return e}))]).then((function(t){var n=t[0],o=t[1];n&&(O.textContent=n.name,N.textContent=n.about,z.style.backgroundImage="url('".concat(n.avatar,"')")),o.length>0&&o.forEach((function(t){var o=e(t,{handleDeleteCard:M,handleLikeCard:$,handleOpenCard:G},n._id);_.append(o)}))})).catch((function(e){console.log(e)}));var I={};function M(e,t){I={id:e,cardElement:t},n(g)}function $(e,n,o){e.classList.contains("card__like-button_is-active")?(function(e){return fetch("".concat(h.baseUrl,"/cards/likes/").concat(e),{method:"DELETE",headers:h.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}(o).then((function(e){return n.textContent=e.likes?e.likes.length:0})).catch((function(e){console.log(e)})),t(e)):(function(e){return fetch("".concat(h.baseUrl,"/cards/likes/").concat(e),{method:"PUT",headers:h.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}(o).then((function(e){return n.textContent=e.likes?e.likes.length:0})).catch((function(e){console.log(e)})),t(e))}function W(e,t,n){e.preventDefault(),n(),o(t)}v.addEventListener("click",(function(){P.value=O.textContent,A.value=N.textContent,u(C,H),n(C)})),y.addEventListener("click",(function(){u(b,H),n(b),T.reset()})),S.addEventListener("click",(function(){u(x,H),n(x),D.reset()})),j.addEventListener("submit",(function(e){W(e,C,(function(){var e,t,n=j.querySelector(H.submitButtonSelector),o=n.textContent;n.textContent=J,(e=P.value,t=A.value,fetch("".concat(h.baseUrl,"/users/me"),{method:"PATCH",headers:h.headers,body:JSON.stringify({name:e,about:t})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).then((function(e){O.textContent=e.name,N.textContent=e.about})).finally((function(){n.textContent=o}))}))})),T.addEventListener("submit",(function(t){W(t,b,(function(){var t=T.querySelector(H.submitButtonSelector),n=t.textContent;t.textContent=J;var o,r,c={name:U.value,link:w.value};(o=c.name,r=c.link,fetch("".concat(h.baseUrl,"/cards"),{method:"POST",headers:h.headers,body:JSON.stringify({name:o,link:r})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).then((function(t){var n=e(t,{handleDeleteCard:M,handleLikeCard:$,handleOpenCard:G},t.owner._id);_.prepend(n),T.reset()})).finally((function(){t.textContent=n}))}))})),B.addEventListener("submit",(function(e){I.cardElement&&W(e,g,(function(){var e;(e=I.id,fetch("".concat(h.baseUrl,"/cards/").concat(e),{method:"DELETE",headers:h.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).then((function(){I.cardElement.remove(),I={}})).catch((function(e){console.log(e)}))}))})),D.addEventListener("submit",(function(e){W(e,x,(function(){var e=D.elements.link.value,t=D.querySelector(H.submitButtonSelector),n=t.textContent;t.textContent=J,fetch(e,{method:"HEAD"}).then((function(t){if(!t.ok)return Promise.reject("".concat(t.status));var n,o=t.headers.get("Content-Type");return o&&o.startsWith("image/")?(n=e,fetch("".concat(h.baseUrl,"/users/me/avatar"),{method:"PATCH",headers:h.headers,body:JSON.stringify({avatar:n})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))):Promise.reject("ссылка не является изображением")})).then((function(){z.style.backgroundImage="url('".concat(e,"')"),o(x),D.reset()})).catch((function(e){console.log("Ошибка: ".concat(e))})).finally((function(){t.textContent=n}))}))})),k.forEach((function(e){var t=e.querySelector(".popup__close");t&&t.addEventListener("click",(function(){return o(e)})),e.addEventListener("mousedown",(function(t){t.target.classList.contains("popup")&&o(e)}))}))})();