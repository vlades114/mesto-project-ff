(()=>{"use strict";var e=function(e,n,r){var o=n.handleDeleteCard,c=n.handleLikeCard,a=n.handleOpenCard,u=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0),i=u.querySelector(".card__image"),s=u.querySelector(".card__title"),l=u.querySelector(".card__delete-button"),d=u.querySelector(".card__like-button"),p=u.querySelector(".card__like-counter"),f=!!e.likes&&e.likes.some((function(e){return e._id===r}));return i.src=e.link,i.alt=e.name,s.textContent=e.name,p.textContent=e.likes?e.likes.length:0,e.owner._id!==r&&l.classList.add("card__delete-button_disabled"),f&&t(d),l.addEventListener("click",(function(){return o(e._id,u)})),d.addEventListener("click",(function(){return c(d,p,e._id)})),i.addEventListener("click",(function(){return a(e.link,e.alt,e.name)})),u},t=function(e){e.classList.toggle("card__like-button_is-active")},n=function(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",o)},r=function(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",o)},o=function(e){if("Escape"===e.key){var t=document.querySelector(".popup_is-opened");t&&r(t)}},c=/^[a-zа-яё\-\s]+$/i,a=/^(https?:\/\/)?([\w.-]+)\.([a-z]{2,})(\/.*)?$/i,u=function(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);n.forEach((function(n){return d(e,n,t.inputErrorClass,t.errorClass)})),i(n,r,t.inactiveButtonClass)};function i(e,t,n){!function(e){return e.some((function(e){return!s(e)}))}(e)?t.classList.remove(n):t.classList.add(n)}var s=function(e){var t=e.validity.valid;return p(e)||(t=!1),t},l=function(e,t,n,r){var o=e.querySelector(".popup__error_type_".concat(t.name));t.classList.add(n),o.textContent=t.validationMessage,t.validity.valid&&!p(t)&&f(t)&&(o.textContent=t.dataset.errorMessage),o.classList.add(r)},d=function(e,t,n,r){var o=e.querySelector(".popup__error_type_".concat(t.name));t.classList.remove(n),o.classList.remove(r),o.textContent=""},p=function(e){return f(e)?c.test(e.value):!m(e)||a.test(e.value)},f=function(e){var t=!1;return"name"!==e.name&&"place-name"!==e.name&&"description"!==e.name||(t=!0),t},m=function(e){var t=!1;return"link"===e.name&&(t=!0),t},h={baseUrl:"https://nomoreparties.co/v1/wff-cohort-39/",headers:{authorization:"3e77b996-5a4b-4cbf-94e8-9001ccd7f1ef","Content-Type":"application/json"}},_=document.querySelector(".places__list"),v=document.querySelector(".profile__edit-button"),y=document.querySelector(".profile__add-button"),S=document.querySelector(".profile__image-overlay"),k=document.querySelectorAll(".popup"),C=document.querySelector(".popup_type_edit"),b=document.querySelector(".popup_type_new-card"),E=document.querySelector(".popup_type_image"),q=document.querySelector(".popup__image"),L=document.querySelector(".popup__caption"),g=document.querySelector(".popup_type_delete-card"),x=document.querySelector(".popup_type_update-avatar"),j=document.forms["edit-profile"],P=j.elements.name,A=j.elements.description,D=document.forms["new-place"],T=D.elements["place-name"],U=D.elements.link,w=document.forms["delete-card"],B=document.forms["update-avatar"],O=document.querySelector(".profile__title"),N=document.querySelector(".profile__description"),z=document.querySelector(".profile__image"),H={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},J="Сохранение...";function G(e,t,r){q.src=e,q.alt=t,L.textContent=r,n(E)}!function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((function(t){t.addEventListener("submit",(function(e){e.preventDefault()}));var n=Array.from(t.querySelectorAll(e.inputSelector)),r=t.querySelector(e.submitButtonSelector);u(t,e),n.forEach((function(o){f(o)&&o.setAttribute("data-error-message","Разрешены только латинские, кириллические буквы, знаки дефиса и пробелы"),o.addEventListener("input",(function(){(function(e,t,n,r){s(t)?d(e,t,n,r):l(e,t,n,r)})(t,o,e.inputErrorClass,e.errorClass),i(n,r,e.inactiveButtonClass)}))}))}))}(H),Promise.all([fetch("".concat(h.baseUrl,"/users/me"),{method:"GET",headers:h.headers}).then((function(e){return e.ok?e.json():Promise.reject(e.status)})).then((function(e){return e})).catch((function(e){console.log("Ошибка: ".concat(e))})),fetch("".concat(h.baseUrl,"/cards"),{method:"GET",headers:h.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).then((function(e){return e}))]).then((function(t){var n=t[0],r=t[1];n&&(O.textContent=n.name,N.textContent=n.about,z.style.backgroundImage="url('".concat(n.avatar,"')")),r.length>0&&r.forEach((function(t){var r=e(t,{handleDeleteCard:M,handleLikeCard:$,handleOpenCard:G},n._id);_.append(r)}))})).catch((function(e){console.log(e)}));var I={};function M(e,t){I={id:e,cardElement:t},n(g)}function $(e,n,r){e.classList.contains("card__like-button_is-active")?(function(e){return fetch("".concat(h.baseUrl,"/cards/likes/").concat(e),{method:"DELETE",headers:h.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}(r).then((function(e){return n.textContent=e.likes?e.likes.length:0})).catch((function(e){console.log(e)})),t(e)):(function(e){return fetch("".concat(h.baseUrl,"/cards/likes/").concat(e),{method:"PUT",headers:h.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}(r).then((function(e){return n.textContent=e.likes?e.likes.length:0})).catch((function(e){console.log(e)})),t(e))}v.addEventListener("click",(function(){P.value=O.textContent,A.value=N.textContent,u(C,H),n(C)})),y.addEventListener("click",(function(){u(b,H),n(b),D.reset()})),S.addEventListener("click",(function(){u(x,H),n(x),B.reset()})),j.addEventListener("submit",(function(e){e.preventDefault();var t,n,o=j.querySelector(H.submitButtonSelector),c=o.textContent;o.textContent=J,(t=P.value,n=A.value,fetch("".concat(h.baseUrl,"/users/me"),{method:"PATCH",headers:h.headers,body:JSON.stringify({name:t,about:n})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).then((function(e){O.textContent=e.name,N.textContent=e.about,r(C)})).finally((function(){o.textContent=c}))})),D.addEventListener("submit",(function(t){t.preventDefault();var n=D.querySelector(H.submitButtonSelector),o=n.textContent;n.textContent=J;var c,a,u={name:T.value,link:U.value};(c=u.name,a=u.link,fetch("".concat(h.baseUrl,"/cards"),{method:"POST",headers:h.headers,body:JSON.stringify({name:c,link:a})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).then((function(t){var n=e(t,{handleDeleteCard:M,handleLikeCard:$,handleOpenCard:G},t.owner._id);_.prepend(n),r(b),D.reset()})).finally((function(){n.textContent=o}))})),w.addEventListener("submit",(function(e){var t;(e.preventDefault(),I.cardElement)&&(t=I.id,fetch("".concat(h.baseUrl,"/cards/").concat(t),{method:"DELETE",headers:h.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))).then((function(){I.cardElement.remove(),I={},r(g)})).catch((function(e){console.log(e)}))})),B.addEventListener("submit",(function(e){e.preventDefault();var t=B.elements.link.value,n=B.querySelector(H.submitButtonSelector),o=n.textContent;n.textContent=J,fetch(t,{method:"HEAD"}).then((function(e){if(!e.ok)return Promise.reject("".concat(e.status));var n,r=e.headers.get("Content-Type");return r&&r.startsWith("image/")?(n=t,fetch("".concat(h.baseUrl,"/users/me/avatar"),{method:"PATCH",headers:h.headers,body:JSON.stringify({avatar:n})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))):Promise.reject("ссылка не является изображением")})).then((function(){z.style.backgroundImage="url('".concat(t,"')"),r(x),B.reset()})).catch((function(e){console.log("Ошибка: ".concat(e))})).finally((function(){n.textContent=o}))})),k.forEach((function(e){var t=e.querySelector(".popup__close");t&&t.addEventListener("click",(function(){return r(e)})),e.addEventListener("mousedown",(function(t){t.target.classList.contains("popup")&&r(e)}))}))})();