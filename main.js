(()=>{"use strict";var e=function(e,n,r){var o=n.handleDeleteCard,c=n.handleLikeCard,a=n.handleOpenCard,u=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0),i=u.querySelector(".card__image"),l=u.querySelector(".card__title"),s=u.querySelector(".card__delete-button"),d=u.querySelector(".card__like-button"),p=u.querySelector(".card__like-counter"),f=!!e.likes&&e.likes.some((function(e){return e._id===r}));return i.src=e.link,i.alt=e.name,l.textContent=e.name,p.textContent=e.likes?e.likes.length:0,e.owner._id!==r&&s.classList.add("card__delete-button_disabled"),f&&t(d),s.addEventListener("click",(function(){return o(e._id,u)})),d.addEventListener("click",(function(){return c(d,p,e._id)})),i.addEventListener("click",(function(){return a(e.link,e.alt,e.name)})),u},t=function(e){e.classList.toggle("card__like-button_is-active")},n=function(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",o)},r=function(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",o)},o=function(e){if("Escape"===e.key){var t=document.querySelector(".popup_is-opened");t&&r(t)}},c=/^[a-zа-яё\-\s]+$/i,a=/^(https?:\/\/)?([\w.-]+)\.([a-z]{2,})(\/.*)?$/i,u=function(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);n.forEach((function(n){return p(e,n,t.inputErrorClass,t.errorClass)})),i(n,r,t.inactiveButtonClass)};function i(e,t,n){!function(e){return e.some((function(e){return!s(e)}))}(e)?t.classList.remove(n):t.classList.add(n)}var l=function(e,t,n,r){s(t)?p(e,t,n,r):d(e,t,n,r)},s=function(e){var t=e.validity.valid;return f(e)||(t=!1),t},d=function(e,t,n,r){var o=e.querySelector(".popup__error_type_".concat(t.name));t.classList.add(n),o.textContent=t.validationMessage,t.validity.valid&&!f(t)&&m(t)&&(o.textContent=t.dataset.errorMessage),o.classList.add(r)},p=function(e,t,n,r){var o=e.querySelector(".popup__error_type_".concat(t.name));t.classList.remove(n),o.classList.remove(r),o.textContent=""},f=function(e){return m(e)?c.test(e.value):!_(e)||a.test(e.value)},m=function(e){var t=!1;return"name"!==e.name&&"place-name"!==e.name&&"description"!==e.name||(t=!0),t},_=function(e){var t=!1;return"link"===e.name&&(t=!0),t},h={baseUrl:"https://nomoreparties.co/v1/wff-cohort-39/",headers:{authorization:"3e77b996-5a4b-4cbf-94e8-9001ccd7f1ef","Content-Type":"application/json"}},v=function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))},y=document.querySelector(".places__list"),S=document.querySelector(".profile__edit-button"),C=document.querySelector(".profile__add-button"),b=document.querySelector(".profile__image-overlay"),k=document.querySelectorAll(".popup"),E=document.querySelector(".popup_type_edit"),q=document.querySelector(".popup_type_new-card"),L=document.querySelector(".popup_type_image"),g=document.querySelector(".popup__image"),x=document.querySelector(".popup__caption"),A=document.querySelector(".popup_type_delete-card"),D=document.querySelector(".popup_type_update-avatar"),T=document.forms["edit-profile"],U=T.elements.name,w=T.elements.description,B=document.forms["new-place"],P=B.elements["place-name"],O=B.elements.link,j=document.forms["delete-card"],N=document.forms["update-avatar"],z=document.querySelector(".profile__title"),H=document.querySelector(".profile__description"),J=document.querySelector(".profile__image"),G={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},I="Сохранение...";function M(e,t,r){g.src=e,g.alt=t,x.textContent=r,n(L)}!function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((function(t){t.addEventListener("submit",(function(e){e.preventDefault()})),u(t,e),function(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);n.forEach((function(o){m(o)&&o.setAttribute("data-error-message","Разрешены только латинские, кириллические буквы, знаки дефиса и пробелы"),o.addEventListener("input",(function(){l(e,o,t.inputErrorClass,t.errorClass),i(n,r,t.inactiveButtonClass)}))}))}(t,e)}))}(G),Promise.all([fetch("".concat(h.baseUrl,"/users/me"),{method:"GET",headers:h.headers}).then((function(e){return v(e)})),fetch("".concat(h.baseUrl,"/cards"),{method:"GET",headers:h.headers}).then((function(e){return v(e)}))]).then((function(t){var n=t[0],r=t[1];n&&(z.textContent=n.name,H.textContent=n.about,J.style.backgroundImage="url('".concat(n.avatar,"')")),r.length>0&&r.forEach((function(t){var r=e(t,{handleDeleteCard:W,handleLikeCard:F,handleOpenCard:M},n._id);y.append(r)}))})).catch((function(e){console.log(e)}));var $={};function W(e,t){$={id:e,cardElement:t},n(A)}function F(e,n,r){e.classList.contains("card__like-button_is-active")?function(e){return fetch("".concat(h.baseUrl,"/cards/likes/").concat(e),{method:"DELETE",headers:h.headers}).then((function(e){return v(e)}))}(r).then((function(r){n.textContent=r.likes?r.likes.length:0,t(e)})).catch((function(e){console.log(e)})):function(e){return fetch("".concat(h.baseUrl,"/cards/likes/").concat(e),{method:"PUT",headers:h.headers}).then((function(e){return v(e)}))}(r).then((function(r){n.textContent=r.likes?r.likes.length:0,t(e)})).catch((function(e){console.log(e)}))}S.addEventListener("click",(function(){U.value=z.textContent,w.value=H.textContent,u(E,G),n(E)})),C.addEventListener("click",(function(){n(q)})),b.addEventListener("click",(function(){u(D,G),n(D),N.reset()})),T.addEventListener("submit",(function(e){e.preventDefault();var t,n,o=T.querySelector(G.submitButtonSelector),c=o.textContent;o.textContent=I,(t=U.value,n=w.value,fetch("".concat(h.baseUrl,"/users/me"),{method:"PATCH",headers:h.headers,body:JSON.stringify({name:t,about:n})}).then((function(e){return v(e)}))).then((function(e){z.textContent=e.name,H.textContent=e.about,r(E)})).finally((function(){o.textContent=c}))})),B.addEventListener("submit",(function(t){t.preventDefault();var n=B.querySelector(G.submitButtonSelector),o=n.textContent;n.textContent=I;var c,a,i={name:P.value,link:O.value};(c=i.name,a=i.link,fetch("".concat(h.baseUrl,"/cards"),{method:"POST",headers:h.headers,body:JSON.stringify({name:c,link:a})}).then((function(e){return v(e)}))).then((function(t){var n=e(t,{handleDeleteCard:W,handleLikeCard:F,handleOpenCard:M},t.owner._id);y.prepend(n),r(q),u(q,G),B.reset()})).finally((function(){n.textContent=o}))})),j.addEventListener("submit",(function(e){var t;(e.preventDefault(),$.cardElement)&&(t=$.id,fetch("".concat(h.baseUrl,"/cards/").concat(t),{method:"DELETE",headers:h.headers}).then((function(e){return v(e)}))).then((function(){$.cardElement.remove(),$={},r(A)})).catch((function(e){console.log(e)}))})),N.addEventListener("submit",(function(e){e.preventDefault();var t=N.elements.link.value,n=N.querySelector(G.submitButtonSelector),o=n.textContent;n.textContent=I,fetch(t,{method:"HEAD"}).then((function(e){if(!e.ok)return Promise.reject("".concat(e.status));var n,r=e.headers.get("Content-Type");return r&&r.startsWith("image/")?(n=t,fetch("".concat(h.baseUrl,"/users/me/avatar"),{method:"PATCH",headers:h.headers,body:JSON.stringify({avatar:n})}).then((function(e){return v(e)}))):Promise.reject("ссылка не является изображением")})).then((function(){J.style.backgroundImage="url('".concat(t,"')"),r(D),N.reset()})).catch((function(e){console.log("Ошибка: ".concat(e))})).finally((function(){n.textContent=o}))})),k.forEach((function(e){var t=e.querySelector(".popup__close");t&&t.addEventListener("click",(function(){return r(e)})),e.addEventListener("mousedown",(function(t){t.target.classList.contains("popup")&&r(e)}))}))})();